# PostgreSQL JSON使用

## 1. 操作符

### 1.1 JSON和JSON共同操作符

| 操作符 | 返回类型 | 数组[1,2,3]                      | {"a":1,"b":2,"c":3}                          | {"a":{"b":{"c":1}},"d":[4,5,6]}                              |
| ------ | -------- | -------------------------------- | -------------------------------------------- | ------------------------------------------------------------ |
| ->     | json     | select '[1,2,3]'::jsonb ->2 = 3  | select '{"a":1,"b":2,"c":3}'::jsonb-> 'a'=1  | select '{"a":{"b":{"c":1}},"d":[4,5,6]}'::jsonb ->'a'={"b": {"c": 1}} |
| ->>    | text     | select '[1,2,3]'::jsonb ->>2 = 3 | select '{"a":1,"b":2,"c":3}'::jsonb->> 'a'=1 | select '{"a":{"b":{"c":1}},"d":[4,5,6]}'::jsonb ->>'a'={"b": {"c": 1}} |
| #>     | json     | --                               | --                                           | select '{"a":{"b":{"c":1}},"d":[4,5,6]}'::jsonb #> '{a,b}' ={"c": 1} |
| #>>    | text     | --                               | --                                           | select '{"a":{"b":{"c":1}},"d":[4,5,6]}'::jsonb #> '{a,b}' ={"c": 1} |

### 1.2 JSONB额外操作符

| 操作符 | 右操作数类型 | 描述                                                         | 例子                                            |
| :----: | ------------ | ------------------------------------------------------------ | ----------------------------------------------- |
|  @>  | jsonb        | 左边的 JSON 值是否包含顶层右边JSON路径/值项?                 | '{"a":1, "b":2}'::jsonb @> '{"b":2}'::jsonb     |
|  <@  | jsonb        | 左边的JSON路径/值是否包含在顶层右边JSON值中？                | '{"b":2}'::jsonb <@ '{"a":1, "b":2}'::jsonb     |
|  ?   | text         | 字符串是否作为顶层键值存在于JSON值中？                       | '{"a":1, "b":2}'::jsonb ? 'b'                   |
|  ?\|  | text[]       | 这些数组字符串中的任何一个是否作为顶层键值存在？             | '{"a":1, "b":2, "c":3}'::jsonb ?\|array['b',c'] |
|  ?&  | text[]       | 这些数组字符串是否作为顶层键值存在？                         | '["a", "b"]'::jsonb ?& array['a', 'b']          |
|  \|\|  | jsonb        | 连接两个jsonb值到新的jsonb值                                 | '["a", "b"]'::jsonb\|\| '["c", "d"]'::jsonb     |
|  -   | text         | 从左操作数中删除键/值对或字符串元素。基于键值匹配键/值对。   | '{"a": "b"}'::jsonb - 'a'                       |
|  -   | integer      | 删除指定索引的数组元素（负整数结尾）。如果顶层容器不是一个数组，那么抛出错误。 | '["a", "b"]'::jsonb - 1                         |
|  #-  | text[]       | 删除指定路径的域或元素（JSON数组，负整数结尾）               | '["a", {"b":1}]'::jsonb #- '{1,b}'              |


## 2. JSON

```sql
-- 简单标量/基本值
-- 基本值可以是数字、带引号的字符串、true、false或者null
SELECT '5'::json;

-- 有零个或者更多元素的数组（元素不需要为同一类型）
SELECT '[1, 2, "foo", null]'::json;

-- 包含键值对的对象
-- 注意对象键必须总是带引号的字符串
SELECT '{"bar": "baz", "balance": 7.77, "active": false}'::json;

-- 数组和对象可以被任意嵌套
SELECT '{"foo": [true, "bar"], "tags": {"a": 1, "b": null}}'::json;
```

## 3. JSONB

### 3.1 包含匹配

```sql
-- 简单的标量/基本值只包含相同的值：
SELECT '"foo"'::jsonb @> '"foo"'::jsonb;

-- 右边的数字被包含在左边的数组中：
SELECT '[1, 2, 3]'::jsonb @> '[1, 3]'::jsonb;

-- 数组元素的顺序没有意义，因此这个例子也返回真：
SELECT '[1, 2, 3]'::jsonb @> '[3, 1]'::jsonb;

-- 重复的数组元素也没有关系：
SELECT '[1, 2, 3]'::jsonb @> '[1, 2, 2]'::jsonb;

-- 右边具有一个单一键值对的对象被包含在左边的对象中：
SELECT '{"product": "PostgreSQL", "version": 9.4, "jsonb": true}'::jsonb @> '{"version": 9.4}'::jsonb;

-- 右边的数组不会被认为包含在左边的数组中，即使其中嵌入了一个相似的数组：
SELECT '[1, 2, [1, 3]]'::jsonb @> '[1, 3]'::jsonb;  -- 得到假

-- 但是如果同样也有嵌套，包含就成立：
SELECT '[1, 2, [1, 3]]'::jsonb @> '[[1, 3]]'::jsonb;

-- 类似的，这个例子也不会被认为是包含：
SELECT '{"foo": {"bar": "baz"}}'::jsonb @> '{"bar": "baz"}'::jsonb;  -- 得到假

-- 包含一个顶层键和一个空对象：
SELECT '{"foo": {"bar": "baz"}}'::jsonb @> '{"foo": {}}'::jsonb;
```

> 注意：匹配时数组元素顺序不考虑，并且重复数组元素也只会考虑一次。
